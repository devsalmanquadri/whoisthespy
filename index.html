<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Who is the Spy? - Multiplayer (Dark Neon Theme)</title>
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,700|Luckiest+Guy&display=swap" rel="stylesheet">
    <style>
        /* Advanced Cyberpunk Dark Theme with Neon Accents and Uniform Sizing */
        body {
            margin: 0;
            font-family: 'Roboto', sans-serif;
            background: radial-gradient(circle at center, #0d0d0d, #000000);
            color: #e0e0e0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            width: 90%;
            max-width: 600px;
            background: #1f1f1f;
            border: 2px solid #00d1ff;
            border-radius: 12px;
            padding: 25px 35px;
            margin: 20px;
            box-shadow: 0 8px 20px rgba(0, 209, 255, 0.5);
            position: relative;
            animation: fadeInScale 0.7s ease-out;
            box-sizing: border-box;
        }

        @keyframes fadeInScale {
            0% {
                opacity: 0;
                transform: scale(0.95) translateY(10px);
            }

            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .hidden {
            display: none;
        }

        /* Headers */
        h1 {
            font-family: 'Luckiest Guy', cursive;
            font-size: 2.8em;
            text-align: center;
            color: #ffeb3b;
            margin-bottom: 10px;
            text-shadow: 0 0 10px #ffeb3b, 0 0 20px #ffeb3b;
        }

        h2,
        h3 {
            text-align: center;
            margin-bottom: 12px;
            color: #00d1ff;
            text-shadow: 0 0 6px #00d1ff;
        }

        /* Form Elements */
        input[type="text"],
        select {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #444;
            border-radius: 6px;
            background: #2c2c2c;
            color: #fff;
            font-size: 16px;
            box-sizing: border-box;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        input[type="text"]:focus,
        select:focus {
            outline: none;
            border-color: #00d1ff;
            box-shadow: 0 0 10px #00d1ff;
        }

        /* Buttons */
        button {
            padding: 12px 20px;
            border: none;
            background: linear-gradient(45deg, #ff8a65, #ff7043);
            color: #fff;
            border-radius: 6px;
            font-size: 16px;
            margin: 10px 0;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 209, 255, 0.4);
        }

        button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(0, 209, 255, 0.6);
        }

        button:active {
            transform: scale(0.98);
        }

        /* Horizontal Rule */
        hr {
            border: none;
            border-top: 1px solid #444;
            margin: 20px 0;
        }

        /* Participants List */
        ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        li {
            background: #222;
            margin: 8px 0;
            padding: 10px 12px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 48px;
            box-sizing: border-box;
            transition: background 0.3s ease;
        }

        li:hover {
            background: #2a2a2a;
        }

        .out-player {
            color: #ff5252;
            font-weight: bold;
            text-shadow: 0 0 5px #ff5252;
        }

        /* Chat Styles */
        .chat-container {
            border: 1px solid #444;
            border-radius: 6px;
            background: #121212;
            padding: 10px;
            max-height: 100px;
            overflow-y: auto;
            margin-bottom: 12px;
            box-sizing: border-box;
        }

        .chat-message {
            margin-bottom: 8px;
            font-size: 14px;
        }

        .chat-sender {
            font-weight: bold;
            color: #ffeb3b;
        }

        .chat-input-group {
            display: flex;
        }

        .chat-input-group input[type="text"] {
            flex: 1;
            margin-right: 10px;
            padding: 10px;
            border: 1px solid #444;
            border-radius: 6px;
            background: #2c2c2c;
            color: #fff;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }

        .chat-input-group input[type="text"]:focus {
            border-color: #00d1ff;
        }

        /* Manage Panel */
        .manage-panel {
            border: 1px solid #444;
            border-radius: 6px;
            padding: 10px;
            background: #121212;
            margin: 10px 0;
        }

        /* End Round Button */
        #endRoundSection button {
            background: linear-gradient(45deg, #66bb6a, #81c784);
        }

        #endRoundSection button:hover {
            background: linear-gradient(45deg, #43a047, #66bb6a);
        }

        /* Spectator Info Panel */
        #spectatorInfo {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #444;
            border-radius: 6px;
            background: #121212;
            font-size: 14px;
            color: #00d1ff;
        }

        /* Round Number Pulse Animation */
        @keyframes roundPulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.2);
                opacity: 0.6;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .round-animate {
            animation: roundPulse 1s ease;
        }

        /* Extra Fun Touches */
        .container {
            border: 2px solid #00d1ff;
        }
    </style>
</head>

<body>
    <!-- MENU VIEW: Create or Join a Game -->
    <div class="container" id="menu">
        <h1>Who is the Spy?</h1>
        <h2>Create Game</h2>
        <input type="text" id="hostNameInput" placeholder="Enter Your Name (Host)">
        <button onclick="createGame()">Create Game</button>
        <hr>
        <h2>Join Game</h2>
        <input type="text" id="joinGameCodeInput" placeholder="Enter Game Code">
        <input type="text" id="playerNameJoinInput" placeholder="Enter Your Name">
        <select id="roleSelect">
            <option value="player">Join as Player</option>
            <option value="spectator">Join as Spectator</option>
        </select>
        <button onclick="joinGame()">Join Game</button>
        <hr>
        <!-- Clear Progress Button -->
        <button onclick="clearProgress()">Clear Progress</button>
    </div>

    <!-- LOBBY VIEW -->
    <div class="container hidden" id="lobby">
        <h1>Lobby</h1>
        <p>Room Code: <strong id="lobbyGameCode"></strong></p>
        <p>Round: <span id="lobbyRound">1</span></p>
        <h2>Participants:</h2>
        <ul id="playersList"></ul>
        <div id="hostControls" class="hidden">
            <button onclick="startGame()">Start Game</button>
            <button onclick="changeWordPair()">Change Word Pair</button>
            <button onclick="endGame()">End Game</button>
        </div>
        <button onclick="toggleRole()">Switch Role</button>
        <hr>
        <h2>Chat</h2>
        <div class="chat-container" id="chatContainerLobby"></div>
        <div class="chat-input-group">
            <input type="text" id="chatInputLobby" placeholder="Type your message...">
            <button onclick="sendChatMessage()">Send</button>
        </div>
        <hr>
        <button onclick="leaveGame()">Leave Game</button>
    </div>

    <!-- GAME VIEW -->
    <div class="container hidden" id="gameView">
        <h1>Game - Round <span id="gameRound">1</span></h1>
        <p>Room Code: <strong id="gameRoomCode"></strong></p>
        <p>Welcome, <strong id="currentPlayerNameDisplay"></strong> <span id="roleDisplay"></span></p>
        <div id="playerActions" class="hidden">
            <button onclick="showWord()">Show My Word</button>
            <h2>Vote for the Spy</h2>
            <div id="voteButtons" style="text-align:center;"></div>
        </div>
        <button onclick="toggleRole()">Switch Role</button>
        <h2>Your Score: <span id="playerScore">0</span></h2>
        <div id="endRoundSection" class="hidden">
            <button onclick="endRound()">End Round</button>
        </div>
        <div id="managePlayersSection" class="hidden">
            <button onclick="toggleManagePanel()">Manage Players</button>
            <div id="managePanel" class="manage-panel hidden"></div>
            <button onclick="endGame()">End Game</button>
        </div>
        <hr>
        <h2>Chat</h2>
        <div class="chat-container" id="chatContainerGame"></div>
        <div class="chat-input-group">
            <input type="text" id="chatInputGame" placeholder="Type your message...">
            <button onclick="sendChatMessage()">Send</button>
        </div>
        <hr>
        <button onclick="backToLobby()">Back to Lobby</button>
        <!-- Spectator Info Panel (visible only for spectators) -->
        <div id="spectatorInfo" class="hidden"></div>
    </div>

    <!-- Firebase & JavaScript -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script>
        /* UPDATE WITH YOUR FIREBASE PROJECT CONFIGURATION */
        var firebaseConfig = {
            apiKey: "AIzaSyBz-61kpp649sRpszY6QzxPoK1_EeecR4I",
            authDomain: "who-is-the-spy-2790c.firebaseapp.com",
            databaseURL: "https://who-is-the-spy-2790c-default-rtdb.firebaseio.com",
            projectId: "who-is-the-spy-2790c",
            storageBucket: "who-is-the-spy-2790c.firebasestorage.app",
            messagingSenderId: "666150577720",
            appId: "1:666150577720:web:ea50455ec29ea0a93ee8cd",
            measurementId: "G-YKSRP0LYRQ"
        };
        firebase.initializeApp(firebaseConfig);
        var database = firebase.database();

        // Global Variables
        let currentRoom = null;
        let currentPlayerName = null;
        let isHost = false;
        let isSpectator = false;
        let gameResetInProgress = false; // Prevent multiple resets

        /* We'll store a JSON object {room, name} in localStorage under the key "playerInfo"
           to ensure the same browser cannot rejoin a room if they were previously in it.
           To allow joining again, the user must click "Clear Progress" on the home page.
        */
        function clearProgress() {
            localStorage.removeItem("playerInfo");
            alert("Progress cleared. You can now join or create a new game.");
        }

        /* MENU FUNCTIONS */
        function createGame() {
            // Check if there's already a record in localStorage
            if (localStorage.getItem("playerInfo")) {
                alert("You have already joined a game in this browser. Please leave the current game or click 'Clear Progress' to start over.");
                return;
            }
            const hostName = document.getElementById('hostNameInput').value.trim();
            if (!hostName) { alert('Please enter your name.'); return; }
            const gameCode = Math.floor(1000 + Math.random() * 9000).toString();
            currentRoom = gameCode;
            currentPlayerName = hostName;
            isHost = true;
            isSpectator = false;
            const randomPair = wordPairs[Math.floor(Math.random() * wordPairs.length)];
            database.ref('rooms/' + gameCode).set({
                host: hostName,
                gameStarted: false,
                round: 1,
                currentWordPair: randomPair,
                players: {},
                chat: {}
            }).then(() => {
                addPlayerToRoom(hostName, false, "unknown");
                localStorage.setItem("playerInfo", JSON.stringify({ room: gameCode, name: hostName }));
                switchToLobby();
            });
        }

        function joinGame() {
            const gameCode = document.getElementById('joinGameCodeInput').value.trim();
            const playerName = document.getElementById('playerNameJoinInput').value.trim();
            let role = document.getElementById('roleSelect').value;
            if (!gameCode || !playerName) { alert('Please enter game code and your name.'); return; }
            // Check localStorage: if playerInfo exists and the stored room equals the game code, block join.
            const storedInfoStr = localStorage.getItem("playerInfo");
            if (storedInfoStr) {
                const storedInfo = JSON.parse(storedInfoStr);
                if (storedInfo.room === gameCode) {
                    alert("You have already been in this room. Please clear progress before rejoining this room.");
                    return;
                }
            }
            actuallyJoinGame(gameCode, playerName, role);
        }

        function actuallyJoinGame(gameCode, playerName, role) {
            database.ref('rooms/' + gameCode).once('value', snapshot => {
                if (snapshot.exists()) {
                    currentRoom = gameCode;
                    currentPlayerName = playerName;
                    if (snapshot.val().gameStarted) {
                        role = "spectator";
                        alert("Game already started. You will join as a spectator.");
                    }
                    isHost = (snapshot.val().host === playerName);
                    isSpectator = (role === "spectator");
                    addPlayerToRoom(playerName, isSpectator, "unknown");
                    localStorage.setItem("playerInfo", JSON.stringify({ room: gameCode, name: playerName }));
                    switchToLobby();
                } else {
                    alert('Game room not found!');
                }
            });
        }

        function addPlayerToRoom(playerName, spectator, ipAddress) {
            if (typeof ipAddress === "undefined" || ipAddress === null) {
                ipAddress = "unknown";
            }
            const playerData = {
                score: 0,
                word: "",
                isSpy: false,
                hasVoted: false,
                hasEndedRound: false,
                isSpectator: spectator,
                isOut: false,
                ip: ipAddress
            };
            database.ref('rooms/' + currentRoom + '/players/' + playerName).set(playerData);
            listenToRoom();
            listenToChat();
        }

        /* ROOM LISTENER & UI UPDATES */
        function listenToRoom() {
            database.ref('rooms/' + currentRoom).on('value', snapshot => {
                const roomData = snapshot.val();
                if (!roomData) {
                    alert("Game has ended. Returning to main menu.");
                    resetLocalState();
                    return;
                }
                document.getElementById('lobbyGameCode').innerText = currentRoom;
                document.getElementById('lobbyRound').innerText = roomData.round;
                document.getElementById('gameRoomCode').innerText = currentRoom;
                updatePlayersList(roomData.players);
                if (roomData.gameStarted) {
                    if (!gameResetInProgress) {
                        let spyFound = false;
                        for (let name in roomData.players) {
                            if (!roomData.players[name].isSpectator && roomData.players[name].isSpy && !roomData.players[name].isOut) {
                                spyFound = true;
                                break;
                            }
                        }
                        if (!spyFound) {
                            gameResetInProgress = true;
                            addChatMessage('System', "No active spy found. Ending round.");
                            database.ref('rooms/' + currentRoom).update({ gameStarted: false }).then(() => {
                                setTimeout(resetGame, 2000);
                            });
                            return;
                        }
                    }
                    switchToGameView(roomData);
                } else {
                    document.getElementById('lobby').classList.remove('hidden');
                    document.getElementById('gameView').classList.add('hidden');
                }
                if (isHost) {
                    document.getElementById('hostControls').classList.remove('hidden');
                    document.getElementById('managePlayersSection').classList.remove('hidden');
                } else {
                    document.getElementById('hostControls').classList.add('hidden');
                    document.getElementById('managePlayersSection').classList.add('hidden');
                }
            });
        }

        function updatePlayersList(players) {
            const playersList = document.getElementById('playersList');
            playersList.innerHTML = '';
            for (let participant in players) {
                const pData = players[participant];
                let li = document.createElement('li');
                li.innerText = participant + ' (Score: ' + pData.score + ') ' + (pData.isSpectator ? '[Spectator]' : '');
                if (pData.isOut) { li.classList.add('out-player'); }
                if (isHost && participant !== currentPlayerName) {
                    let kickBtn = document.createElement('button');
                    kickBtn.innerText = 'Kick';
                    kickBtn.className = 'kick-btn';
                    kickBtn.onclick = () => kickPlayer(participant);
                    li.appendChild(kickBtn);
                }
                playersList.appendChild(li);
            }
            if (isHost) updateManagePanel(players);
        }

        function kickPlayer(participantName) {
            if (!isHost) return;
            database.ref('rooms/' + currentRoom + '/players/' + participantName).once('value', snapshot => {
                const pData = snapshot.val();
                if (pData && pData.isSpy) {
                    database.ref('rooms/' + currentRoom).update({ gameStarted: false });
                }
                if (confirm('Kick ' + participantName + '?')) {
                    database.ref('rooms/' + currentRoom + '/players/' + participantName).remove();
                    addChatMessage('System', participantName + ' was kicked by the host.');
                }
            });
        }

        function switchToLobby() {
            document.getElementById('menu').classList.add('hidden');
            document.getElementById('lobby').classList.remove('hidden');
            document.getElementById('gameView').classList.add('hidden');
        }

        /* CHAT FUNCTIONS */
        function listenToChat() {
            database.ref('rooms/' + currentRoom + '/chat').on('child_added', snapshot => {
                const msg = snapshot.val();
                displayChatMessage(msg.sender, msg.message, msg.timestamp);
            });
        }

        function displayChatMessage(sender, message, timestamp) {
            const messageElement = document.createElement('div');
            messageElement.className = 'chat-message';
            const time = new Date(timestamp).toLocaleTimeString();
            messageElement.innerHTML = '<span class="chat-sender">' + sender + '</span> [' + time + ']: ' + message;
            let chatContainer = document.getElementById('lobby').classList.contains('hidden')
                ? document.getElementById('chatContainerGame')
                : document.getElementById('chatContainerLobby');
            chatContainer.appendChild(messageElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function sendChatMessage() {
            let chatInput = document.getElementById('lobby').classList.contains('hidden')
                ? document.getElementById('chatInputGame')
                : document.getElementById('chatInputLobby');
            const message = chatInput.value.trim();
            if (!message) return;
            const msgData = { sender: currentPlayerName, message: message, timestamp: Date.now() };
            database.ref('rooms/' + currentRoom + '/chat').push(msgData);
            chatInput.value = '';
        }

        function addChatMessage(sender, message) {
            const msgData = { sender: sender, message: message, timestamp: Date.now() };
            database.ref('rooms/' + currentRoom + '/chat').push(msgData);
        }

        /* GAME FUNCTIONS */
        function showWord() {
            if (isSpectator) {
                alert("Spectators do not have a secret word.");
                return;
            }
            database.ref('rooms/' + currentRoom + '/players/' + currentPlayerName)
                .once('value', snapshot => {
                    const pData = snapshot.val();
                    alert('Your word is: ' + pData.word);
                });
        }

        function startGame() {
            if (!isHost) return;
            database.ref('rooms/' + currentRoom + '/players')
                .once('value', snapshot => {
                    const playersData = snapshot.val();
                    const activePlayers = Object.keys(playersData).filter(name => !playersData[name].isSpectator && !playersData[name].isOut);
                    if (activePlayers.length < 2) { alert("Need at least 2 active players."); return; }
                    const randomIndex = Math.floor(Math.random() * activePlayers.length);
                    const spyName = activePlayers[randomIndex];
                    database.ref('rooms/' + currentRoom)
                        .once('value', roomSnapshot => {
                            const roomData = roomSnapshot.val();
                            const commonWord = roomData.currentWordPair.common;
                            const spyWord = roomData.currentWordPair.spy;
                            let updates = {};
                            for (let name in playersData) {
                                if (!playersData[name].isSpectator && !playersData[name].isOut) {
                                    updates['players/' + name + '/isSpy'] = (name === spyName);
                                    updates['players/' + name + '/word'] = (name === spyName) ? spyWord : commonWord;
                                    updates['players/' + name + '/hasVoted'] = false;
                                    updates['players/' + name + '/hasEndedRound'] = false;
                                }
                            }
                            updates['gameStarted'] = true;
                            updates['votes'] = null;
                            database.ref('rooms/' + currentRoom).update(updates);
                            addChatMessage('System', 'Game has started! Roles assigned. [Word pair is hidden]');
                        });
                });
        }

        function castVote(votedName) {
            database.ref('rooms/' + currentRoom + '/players/' + currentPlayerName)
                .once('value', snapshot => {
                    const pData = snapshot.val();
                    if (pData.hasVoted) { alert('You have already voted.'); return; }
                    let voteUpdate = {};
                    voteUpdate[currentPlayerName] = votedName;
                    database.ref('rooms/' + currentRoom + '/votes').update(voteUpdate);
                    addChatMessage('Vote', currentPlayerName + ' voted for ' + votedName);
                    database.ref('rooms/' + currentRoom + '/players/' + currentPlayerName + '/hasVoted')
                        .set(true).then(checkAllVotes);
                });
        }

        function updateVoteButtons(players) {
            const voteDiv = document.getElementById('voteButtons');
            voteDiv.innerHTML = '';
            for (let name in players) {
                if (name === currentPlayerName) continue;
                if (players[name].isSpectator || players[name].isOut) continue;
                let btn = document.createElement('button');
                btn.innerText = name;
                btn.onclick = () => castVote(name);
                voteDiv.appendChild(btn);
            }
        }

        function checkAllVotes() {
            database.ref('rooms/' + currentRoom + '/players')
                .once('value', snapshot => {
                    const playersData = snapshot.val();
                    let allVoted = true;
                    for (let name in playersData) {
                        if (!playersData[name].isSpectator && !playersData[name].isOut && playersData[name].hasVoted === false) {
                            allVoted = false;
                            break;
                        }
                    }
                    if (allVoted) {
                        animateRoundNumber();
                        tallyVotes();
                    }
                });
        }

        function animateRoundNumber() {
            const roundElem = document.getElementById('gameRound');
            roundElem.classList.add('round-animate');
            roundElem.addEventListener('animationend', () => { roundElem.classList.remove('round-animate'); }, { once: true });
        }

        function tallyVotes() {
            database.ref('rooms/' + currentRoom + '/votes')
                .once('value', snapshot => {
                    const votes = snapshot.val() || {};
                    let tally = {};
                    let voteDetails = [];
                    for (let voter in votes) {
                        let vote = votes[voter];
                        voteDetails.push(voter + " → " + vote);
                        tally[vote] = (tally[vote] || 0) + 1;
                    }
                    addChatMessage('System', "Vote results: " + voteDetails.join(", "));
                    let candidate = null, maxVotes = 0;
                    for (let name in tally) {
                        if (tally[name] > maxVotes) { candidate = name; maxVotes = tally[name]; }
                    }
                    database.ref('rooms/' + currentRoom + '/players/' + candidate)
                        .once('value', snap => {
                            const candidateData = snap.val();
                            if (candidateData && candidateData.isSpy) {
                                database.ref('rooms/' + currentRoom).update({ gameStarted: false });
                                database.ref('rooms/' + currentRoom + '/players/' + candidate + '/isOut').set(true);
                                addChatMessage('System', candidate + " (the spy) has been eliminated this round!");
                                database.ref('rooms/' + currentRoom + '/players')
                                    .once('value', snapAll => {
                                        const allPlayers = snapAll.val();
                                        for (let name in allPlayers) {
                                            if (!allPlayers[name].isSpectator && !allPlayers[name].isSpy && !allPlayers[name].isOut) {
                                                database.ref('rooms/' + currentRoom + '/players/' + name + '/score')
                                                    .transaction(score => (score || 0) + 1);
                                            }
                                        }
                                        gameResetInProgress = true;
                                        setTimeout(resetGame, 3000);
                                    });
                            } else {
                                addChatMessage('System', "Vote complete. No elimination this round. Roles and words will change.");
                                database.ref('rooms/' + currentRoom + '/players')
                                    .once('value', snapAll => {
                                        const allPlayers = snapAll.val();
                                        for (let name in allPlayers) {
                                            if (allPlayers[name].isSpy && !allPlayers[name].isOut) {
                                                database.ref('rooms/' + currentRoom + '/players/' + name + '/score')
                                                    .transaction(score => (score || 0) + 1);
                                            }
                                        }
                                        setTimeout(nextRound, 3000);
                                    });
                            }
                            database.ref('rooms/' + currentRoom + '/votes').remove();
                            database.ref('rooms/' + currentRoom + '/players')
                                .once('value', snapAll => {
                                    const allPlayers = snapAll.val();
                                    for (let name in allPlayers) {
                                        if (!allPlayers[name].isSpectator && !allPlayers[name].isOut) {
                                            database.ref('rooms/' + currentRoom + '/players/' + name + '/hasVoted').set(false);
                                        }
                                    }
                                });
                        });
                });
        }
        function leaveGame() {
            if (currentRoom && currentPlayerName) {
                // Remove the player's record from the room.
                database.ref('rooms/' + currentRoom + '/players/' + currentPlayerName)
                    .remove()
                    .then(() => {
                        // If the current player is the host, remove the entire room.
                        if (isHost) {
                            return database.ref('rooms/' + currentRoom).remove();
                        }
                    })
                    .then(() => {
                        // Clear localStorage and reset local state.
                        localStorage.removeItem("playerInfo");
                        resetLocalState();
                        alert("You have left the game.");
                    })
                    .catch((error) => {
                        console.error("Error leaving game:", error);
                    });
            }
        }


        function updateScore() {
            database.ref('rooms/' + currentRoom + '/players/' + currentPlayerName + '/score')
                .once('value', snapshot => {
                    document.getElementById('playerScore').innerText = snapshot.val() || 0;
                });
        }

        /* End Round Feature for Active Players */
        function endRound() {
            if (isSpectator) return;
            database.ref('rooms/' + currentRoom + '/players/' + currentPlayerName + '/hasEndedRound')
                .set(true).then(() => {
                    addChatMessage('System', currentPlayerName + " ended their round.");
                    checkAllEndedRound();
                });
        }

        function checkAllEndedRound() {
            database.ref('rooms/' + currentRoom + '/players')
                .once('value', snapshot => {
                    const playersData = snapshot.val();
                    let allEnded = true;
                    for (let name in playersData) {
                        if (!playersData[name].isSpectator && !playersData[name].isOut && playersData[name].hasEndedRound === false) {
                            allEnded = false;
                            break;
                        }
                    }
                    if (allEnded) {
                        addChatMessage('System', "All active players ended the round. Advancing to next round.");
                        nextRound();
                    }
                });
        }

        function nextRound() {
            if (!isHost) return;
            database.ref('rooms/' + currentRoom)
                .once('value', snapshot => {
                    const roomData = snapshot.val();
                    const newRound = roomData.round + 1;
                    const playersData = roomData.players;
                    const activePlayers = Object.keys(playersData).filter(name => !playersData[name].isSpectator && !playersData[name].isOut);
                    if (activePlayers.length < 2) {
                        addChatMessage('System', "Not enough active players for next round. Ending game.");
                        gameResetInProgress = true;
                        setTimeout(resetGame, 2000);
                        return;
                    }
                    const randomIndex = Math.floor(Math.random() * activePlayers.length);
                    const spyName = activePlayers[randomIndex];
                    let updates = { round: newRound };
                    for (let name in playersData) {
                        if (!playersData[name].isSpectator && !playersData[name].isOut) {
                            updates['players/' + name + '/isSpy'] = (name === spyName);
                            updates['players/' + name + '/word'] = (name === spyName) ? roomData.currentWordPair.spy : roomData.currentWordPair.common;
                            updates['players/' + name + '/hasVoted'] = false;
                            updates['players/' + name + '/hasEndedRound'] = false;
                        }
                    }
                    updates['votes'] = null;
                    database.ref('rooms/' + currentRoom).update(updates);
                    addChatMessage('System', 'New round started! Roles and words changed. [New word pair is hidden]');
                });
        }

        function changeWordPair() {
            if (!isHost) return;
            const newPair = wordPairs[Math.floor(Math.random() * wordPairs.length)];
            database.ref('rooms/' + currentRoom + '/currentWordPair').set(newPair)
                .then(() => { addChatMessage('System', 'Word pair changed by host.'); });
        }

        function switchToGameView(roomData) {
            document.getElementById('lobby').classList.add('hidden');
            document.getElementById('gameView').classList.remove('hidden');
            document.getElementById('gameRound').innerText = roomData.round;
            document.getElementById('currentPlayerNameDisplay').innerText = currentPlayerName;
            if (!isSpectator && roomData.players[currentPlayerName] && roomData.players[currentPlayerName].isSpy) {
                document.getElementById('roleDisplay').innerText = ' [Spy]';
            } else if (isSpectator) {
                document.getElementById('roleDisplay').innerText = ' [Spectator]';
            } else {
                document.getElementById('roleDisplay').innerText = '';
            }
            if (!isSpectator) {
                document.getElementById('playerActions').classList.remove('hidden');
                updateVoteButtons(roomData.players);
                document.getElementById('endRoundSection').classList.remove('hidden');
            } else {
                document.getElementById('playerActions').classList.add('hidden');
                document.getElementById('endRoundSection').classList.add('hidden');
                let spectatorInfo = document.getElementById("spectatorInfo");
                spectatorInfo.style.display = "block";
                let spyIdentity = "Unknown";
                for (let name in roomData.players) {
                    if (!roomData.players[name].isSpectator && roomData.players[name].isSpy && !roomData.players[name].isOut) {
                        spyIdentity = name;
                        break;
                    }
                }
                spectatorInfo.innerHTML = `<p><strong>Spectator Info:</strong><br>Active Spy: ${spyIdentity}<br>Word Pair: ${roomData.currentWordPair.common} / ${roomData.currentWordPair.spy}</p>`;
            }
            updateScore();
        }

        function toggleManagePanel() {
            const panel = document.getElementById('managePanel');
            panel.classList.toggle('hidden');
        }

        function updateManagePanel(players) {
            const panel = document.getElementById('managePanel');
            panel.innerHTML = '<strong>Manage Participants:</strong><br>';
            for (let name in players) {
                if (name === currentPlayerName) continue;
                const pData = players[name];
                const pDiv = document.createElement('div');
                pDiv.style.marginBottom = "5px";
                pDiv.innerText = name + (pData.isSpectator ? " [Spectator]" : "");
                if (pData.isOut) { pDiv.style.color = "#ff5252"; }
                let kickBtn = document.createElement('button');
                kickBtn.innerText = 'Kick';
                kickBtn.className = 'kick-btn';
                kickBtn.style.marginLeft = "10px";
                kickBtn.onclick = () => kickPlayer(name);
                pDiv.appendChild(kickBtn);
                let outBtn = document.createElement('button');
                outBtn.innerText = pData.isOut ? "Reset Out" : "Mark Out";
                outBtn.style.marginLeft = "10px";
                outBtn.onclick = () => {
                    database.ref('rooms/' + currentRoom + '/players/' + name + '/isOut').set(!pData.isOut);
                };
                pDiv.appendChild(outBtn);
                panel.appendChild(pDiv);
            }
        }

        function backToLobby() {
            document.getElementById('gameView').classList.add('hidden');
            document.getElementById('lobby').classList.remove('hidden');
        }

        function endGame() {
            if (!isHost) return;
            if (confirm('End the game and reset for a new game?')) {
                gameResetInProgress = true;
                resetGame();
            }
        }

        function resetGame() {
            database.ref('rooms/' + currentRoom)
                .once('value', snapshot => {
                    const roomData = snapshot.val();
                    let updates = { gameStarted: false, round: 1, votes: null };
                    for (let name in roomData.players) {
                        updates['players/' + name + '/hasVoted'] = false;
                        updates['players/' + name + '/hasEndedRound'] = false;
                        updates['players/' + name + '/isOut'] = false;
                        updates['players/' + name + '/isSpy'] = false;
                        updates['players/' + name + '/word'] = "";
                    }
                    database.ref('rooms/' + currentRoom).update(updates);
                    addChatMessage('System', 'Game ended and reset. You may now switch roles and start a new game.');
                    gameResetInProgress = false;
                });
        }

        function toggleRole() {
            database.ref('rooms/' + currentRoom).once('value', snapshot => {
                const roomData = snapshot.val();
                if (roomData.gameStarted) {
                    alert("Cannot change role mid-game.");
                    return;
                }
                database.ref('rooms/' + currentRoom + '/players/' + currentPlayerName + '/isSpectator')
                    .once('value', snap => {
                        let currentRole = snap.val();
                        database.ref('rooms/' + currentRoom + '/players/' + currentPlayerName + '/isSpectator')
                            .set(!currentRole)
                            .then(() => {
                                isSpectator = !currentRole;
                                addChatMessage('System', currentPlayerName + " switched to " + (isSpectator ? "Spectator" : "Player") + " mode.");
                            });
                    });
            });
        }

        function updateScore() {
            database.ref('rooms/' + currentRoom + '/players/' + currentPlayerName + '/score')
                .once('value', snapshot => {
                    document.getElementById('playerScore').innerText = snapshot.val() || 0;
                });
        }

        function resetLocalState() {
            currentRoom = null;
            currentPlayerName = null;
            isHost = false;
            isSpectator = false;
            gameResetInProgress = false;
            localStorage.removeItem("playerInfo");
            document.getElementById('menu').classList.remove('hidden');
            document.getElementById('lobby').classList.add('hidden');
            document.getElementById('gameView').classList.add('hidden');
        }

        window.onbeforeunload = function () {
            if (currentRoom && currentPlayerName) {
                database.ref('rooms/' + currentRoom + '/players/' + currentPlayerName).remove();
            }
        };

        /* Word Pairs: Using simple English words with distinct differences */
        const wordPairs = [
            // Block 1 (1–20)
            { common: "apple", spy: "hammer" },
            { common: "dog", spy: "sofa" },
            { common: "tree", spy: "pencil" },
            { common: "river", spy: "phone" },
            { common: "mountain", spy: "cup" },
            { common: "book", spy: "car" },
            { common: "house", spy: "bottle" },
            { common: "flower", spy: "screwdriver" },
            { common: "chair", spy: "keyboard" },
            { common: "rain", spy: "lamp" },
            { common: "cloud", spy: "bicycle" },
            { common: "sun", spy: "radio" },
            { common: "star", spy: "wallet" },
            { common: "wind", spy: "printer" },
            { common: "ice", spy: "scissors" },
            { common: "fire", spy: "mug" },
            { common: "water", spy: "couch" },
            { common: "leaf", spy: "clock" },
            { common: "grass", spy: "computer" },
            { common: "rock", spy: "pillow" },

            // Block 2 (21–40)
            { common: "ocean", spy: "blender" },
            { common: "beach", spy: "fork" },
            { common: "desert", spy: "camera" },
            { common: "forest", spy: "scooter" },
            { common: "valley", spy: "towel" },
            { common: "island", spy: "toaster" },
            { common: "cave", spy: "rake" },
            { common: "bridge", spy: "notebook" },
            { common: "city", spy: "stove" },
            { common: "road", spy: "remote" },
            { common: "village", spy: "bed" },
            { common: "farm", spy: "desk" },
            { common: "barn", spy: "mixer" },
            { common: "castle", spy: "lamp" },
            { common: "temple", spy: "broom" },
            { common: "market", spy: "skirt" },
            { common: "store", spy: "blender" },
            { common: "school", spy: "suitcase" },
            { common: "library", spy: "drill" },
            { common: "museum", spy: "garage" },

            // Block 3 (41–60)
            { common: "pen", spy: "saw" },
            { common: "pencil", spy: "wrench" },
            { common: "paper", spy: "tape" },
            { common: "book", spy: "needle" },
            { common: "map", spy: "scarf" },
            { common: "newspaper", spy: "bottle" },
            { common: "magazine", spy: "fork" },
            { common: "letter", spy: "hammer" },
            { common: "envelope", spy: "plunger" },
            { common: "phone", spy: "sunscreen" },
            { common: "computer", spy: "drum" },
            { common: "keyboard", spy: "speaker" },
            { common: "mouse", spy: "scissors" },
            { common: "monitor", spy: "broom" },
            { common: "printer", spy: "tire" },
            { common: "router", spy: "bucket" },
            { common: "camera", spy: "screwdriver" },
            { common: "headphone", spy: "helmet" },
            { common: "charger", spy: "sandal" },
            { common: "battery", spy: "nail" },

            // Block 4 (61–80)
            { common: "cup", spy: "scalpel" },
            { common: "mug", spy: "chisel" },
            { common: "bottle", spy: "spoon" },
            { common: "plate", spy: "fork" },
            { common: "napkin", spy: "scissors" },
            { common: "stove", spy: "guitar" },
            { common: "refrigerator", spy: "violin" },
            { common: "oven", spy: "drum" },
            { common: "sink", spy: "brush" },
            { common: "dish", spy: "crown" },
            { common: "carpet", spy: "puzzle" },
            { common: "curtain", spy: "balloon" },
            { common: "sofa", spy: "trumpet" },
            { common: "bed", spy: "violin" },
            { common: "pillow", spy: "sledge" },
            { common: "blanket", spy: "screw" },
            { common: "window", spy: "cave" },
            { common: "door", spy: "crayon" },
            { common: "floor", spy: "paper" },
            { common: "ceiling", spy: "keyboard" },

            // Block 5 (81–100)
            { common: "radio", spy: "tiger" },
            { common: "television", spy: "elephant" },
            { common: "remote", spy: "giraffe" },
            { common: "speaker", spy: "monkey" },
            { common: "camera", spy: "crocodile" },
            { common: "video", spy: "dinosaur" },
            { common: "game", spy: "ocean" },
            { common: "movie", spy: "desert" },
            { common: "music", spy: "mountain" },
            { common: "song", spy: "volcano" },
            { common: "guitar", spy: "spaceship" },
            { common: "piano", spy: "submarine" },
            { common: "dance", spy: "hammer" },
            { common: "run", spy: "clock" },
            { common: "swim", spy: "book" },
            { common: "jump", spy: "phone" },
            { common: "ball", spy: "truck" },
            { common: "team", spy: "castle" },
            { common: "sport", spy: "cave" },
            { common: "coach", spy: "flower" },

            // Block 6 (101–120)
            { common: "street", spy: "rocket" },
            { common: "tram", spy: "island" },
            { common: "bridge", spy: "dragon" },
            { common: "city", spy: "galaxy" },
            { common: "country", spy: "ocean" },
            { common: "jungle", spy: "factory" },
            { common: "plain", spy: "museum" },
            { common: "lake", spy: "airport" },
            { common: "island", spy: "temple" },
            { common: "garden", spy: "stadium" },
            { common: "plant", spy: "engine" },
            { common: "bird", spy: "computer" },
            { common: "butterfly", spy: "scooter" },
            { common: "tree", spy: "rocket" },
            { common: "leaf", spy: "crown" },
            { common: "rainbow", spy: "tire" },
            { common: "snow", spy: "wrench" },
            { common: "cloud", spy: "helmet" },
            { common: "sun", spy: "scarf" },
            { common: "moon", spy: "purse" },

            // Block 7 (121–140)
            { common: "t-shirt", spy: "crown" },
            { common: "pants", spy: "sword" },
            { common: "jacket", spy: "shield" },
            { common: "hat", spy: "helmet" },
            { common: "socks", spy: "gloves" },
            { common: "shoes", spy: "boots" },
            { common: "belt", spy: "scarf" },
            { common: "tie", spy: "bow" },
            { common: "sunglasses", spy: "goggles" },
            { common: "dress", spy: "armor" },
            { common: "skirt", spy: "trousers" },
            { common: "coat", spy: "raincoat" },
            { common: "umbrella", spy: "glove" },
            { common: "beanie", spy: "cap" },
            { common: "suit", spy: "jumpsuit" },
            { common: "scarf", spy: "tie" },
            { common: "glasses", spy: "contacts" },
            { common: "coat", spy: "cape" },
            { common: "watch", spy: "clock" },
            { common: "bag", spy: "satchel" },

            // Block 8 (141–160)
            { common: "pen", spy: "nail" },
            { common: "notebook", spy: "hammer" },
            { common: "book", spy: "tire" },
            { common: "chair", spy: "stool" },
            { common: "table", spy: "desk" },
            { common: "lamp", spy: "candle" },
            { common: "door", spy: "window" },
            { common: "bed", spy: "sofa" },
            { common: "rug", spy: "curtain" },
            { common: "remote", spy: "controller" },
            { common: "phone", spy: "calculator" },
            { common: "keyboard", spy: "mouse" },
            { common: "printer", spy: "scanner" },
            { common: "cup", spy: "goblet" },
            { common: "plate", spy: "bowl" },
            { common: "fork", spy: "chopsticks" },
            { common: "knife", spy: "scissors" },
            { common: "clock", spy: "watch" },
            { common: "map", spy: "compass" },
            { common: "envelope", spy: "stamp" },

            // Block 9 (161–180)
            { common: "soccer", spy: "basketball" },
            { common: "tennis", spy: "badminton" },
            { common: "golf", spy: "cricket" },
            { common: "baseball", spy: "football" },
            { common: "swimming", spy: "diving" },
            { common: "running", spy: "cycling" },
            { common: "skiing", spy: "snowboarding" },
            { common: "ice hockey", spy: "rugby" },
            { common: "chess", spy: "checkers" },
            { common: "card", spy: "board game" },
            { common: "video game", spy: "arcade" },
            { common: "movie", spy: "theater" },
            { common: "concert", spy: "festival" },
            { common: "theater", spy: "opera" },
            { common: "museum", spy: "gallery" },
            { common: "park", spy: "amusement park" },
            { common: "picnic", spy: "barbecue" },
            { common: "camping", spy: "hotel" },
            { common: "hiking", spy: "fishing" },
            { common: "jogging", spy: "skating" },

            // Block 10 (181–200)
            { common: "street", spy: "road" },
            { common: "train", spy: "bus" },
            { common: "bridge", spy: "tunnel" },
            { common: "city", spy: "village" },
            { common: "country", spy: "continent" },
            { common: "ocean", spy: "lake" },
            { common: "river", spy: "stream" },
            { common: "mountain", spy: "plateau" },
            { common: "desert", spy: "rainforest" },
            { common: "rain", spy: "snow" },
            { common: "wind", spy: "storm" },
            { common: "sun", spy: "moon" },
            { common: "star", spy: "comet" },
            { common: "cloud", spy: "smoke" },
            { common: "fire", spy: "ice" },
            { common: "gold", spy: "silver" },
            { common: "rock", spy: "crystal" },
            { common: "dirt", spy: "sand" },
            { common: "leaf", spy: "flame" },
            { common: "paper", spy: "plastic" }
        ];

    </script>
</body>

</html>